<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit API Test - Quiz App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="gradient-bg text-white shadow-lg">
        <div class="max-w-4xl mx-auto px-4 py-6">
            <h1 class="text-2xl font-bold flex items-center">
                <i class='bx bx-test-tube text-3xl mr-2'></i>
                Submit API Multi-Device Test
            </h1>
            <p class="text-sm opacity-90 mt-1">Test quiz submission across different devices and browsers</p>
        </div>
    </div>

    <div class="max-w-4xl mx-auto px-4 py-8">
        <!-- Device Info Card -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class='bx bx-mobile text-2xl mr-2 text-blue-600'></i>
                Your Device Info
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div><strong>User Agent:</strong> <span id="userAgent" class="text-gray-600"></span></div>
                <div><strong>Platform:</strong> <span id="platform" class="text-gray-600"></span></div>
                <div><strong>Screen:</strong> <span id="screen" class="text-gray-600"></span></div>
                <div><strong>Language:</strong> <span id="language" class="text-gray-600"></span></div>
                <div><strong>Online:</strong> <span id="online" class="text-gray-600"></span></div>
                <div><strong>Cookie Enabled:</strong> <span id="cookies" class="text-gray-600"></span></div>
            </div>
        </div>

        <!-- Test Form -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class='bx bx-code-alt text-2xl mr-2 text-purple-600'></i>
                Submission Test
            </h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Test Student ID</label>
                    <input 
                        type="text" 
                        id="testIdentifier" 
                        value="TEST_SUBMIT_001" 
                        class="w-full px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none"
                    >
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Number of Test Questions</label>
                    <input 
                        type="number" 
                        id="testQuestionCount" 
                        value="5" 
                        min="1" 
                        max="100"
                        class="w-full px-4 py-2 rounded-lg border-2 border-gray-200 focus:border-purple-500 focus:outline-none"
                    >
                </div>

                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="testRetry" checked class="w-4 h-4">
                    <label for="testRetry" class="text-sm text-gray-700">Enable retry logic (3 attempts)</label>
                </div>

                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="testTimeout" checked class="w-4 h-4">
                    <label for="testTimeout" class="text-sm text-gray-700">Enable 30s timeout per request</label>
                </div>

                <button 
                    onclick="runSubmitTest()" 
                    class="w-full bg-gradient-to-r from-purple-600 to-purple-800 text-white font-bold py-3 px-6 rounded-lg hover:from-purple-700 hover:to-purple-900 transition flex items-center justify-center"
                >
                    <i class='bx bx-play-circle text-xl mr-2'></i>
                    Run Submit Test
                </button>
            </div>
        </div>

        <!-- Test Results -->
        <div id="resultsContainer" class="bg-white rounded-lg shadow-lg p-6 hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class='bx bx-chart text-2xl mr-2 text-green-600'></i>
                Test Results
            </h2>
            <div id="results" class="space-y-3"></div>
        </div>
    </div>

    <footer class="bg-white border-t border-gray-200 py-6 mt-12">
        <div class="max-w-4xl mx-auto px-4 text-center">
            <p class="text-sm text-gray-600">&copy; Quiz App Testing Suite</p>
        </div>
    </footer>

    <script>
        const API = 'api';

        // Display device info
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('userAgent').textContent = navigator.userAgent;
            document.getElementById('platform').textContent = navigator.platform;
            document.getElementById('screen').textContent = `${window.screen.width}x${window.screen.height}`;
            document.getElementById('language').textContent = navigator.language;
            document.getElementById('online').textContent = navigator.onLine ? 'Yes' : 'No';
            document.getElementById('cookies').textContent = navigator.cookieEnabled ? 'Yes' : 'No';
        });

        function addResult(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const container = document.getElementById('resultsContainer');
            container.classList.remove('hidden');

            const colors = {
                info: 'bg-blue-50 border-blue-200 text-blue-800',
                success: 'bg-green-50 border-green-200 text-green-800',
                error: 'bg-red-50 border-red-200 text-red-800',
                warning: 'bg-yellow-50 border-yellow-200 text-yellow-800'
            };

            const icons = {
                info: 'bx-info-circle',
                success: 'bx-check-circle',
                error: 'bx-error-circle',
                warning: 'bx-error'
            };

            const resultEl = document.createElement('div');
            resultEl.className = `${colors[type]} border rounded-lg p-3 text-sm flex items-start`;
            resultEl.innerHTML = `
                <i class='bx ${icons[type]} text-xl mr-2 flex-shrink-0'></i>
                <span>${message}</span>
            `;
            resultsDiv.appendChild(resultEl);
        }

        async function runSubmitTest() {
            const identifier = document.getElementById('testIdentifier').value;
            const questionCount = parseInt(document.getElementById('testQuestionCount').value);
            const enableRetry = document.getElementById('testRetry').checked;
            const enableTimeout = document.getElementById('testTimeout').checked;

            // Clear previous results
            document.getElementById('results').innerHTML = '';
            document.getElementById('resultsContainer').classList.add('hidden');

            addResult(`Starting submit test for ${identifier} with ${questionCount} questions...`, 'info');

            // Generate fake answers
            const answers = {};
            const timings = {};
            const questionIds = [];
            const options = ['A', 'B', 'C', 'D'];

            for (let i = 1; i <= questionCount; i++) {
                questionIds.push(i);
                answers[i] = options[Math.floor(Math.random() * options.length)];
                timings[i] = Math.floor(Math.random() * 60) + 10;
            }

            const sessionId = identifier + '_' + Date.now();

            addResult(`Generated session ID: ${sessionId}`, 'info');
            addResult(`Answers: ${JSON.stringify(answers).substring(0, 100)}...`, 'info');

            const submitPayload = {
                identifier: identifier,
                session_id: sessionId,
                name: 'Test Student',
                answers: answers,
                timings: timings,
                question_ids: questionIds,
                submitted: true,
                group: 1
            };

            const startTime = performance.now();
            let response, data;
            let retries = enableRetry ? 3 : 1;
            let lastError;
            let attemptCount = 0;

            addResult(`Retry enabled: ${enableRetry ? 'Yes (3 attempts)' : 'No (1 attempt)'}`, 'info');
            addResult(`Timeout enabled: ${enableTimeout ? 'Yes (30s)' : 'No'}`, 'info');

            while (retries > 0) {
                attemptCount++;
                try {
                    addResult(`Attempt ${attemptCount}: Sending POST request...`, 'info');

                    const controller = new AbortController();
                    let timeoutId;
                    
                    if (enableTimeout) {
                        timeoutId = setTimeout(() => {
                            addResult(`Timeout triggered after 30s on attempt ${attemptCount}`, 'warning');
                            controller.abort();
                        }, 30000);
                    }

                    response = await fetch(`${API}/sessions.php`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(submitPayload),
                        signal: enableTimeout ? controller.signal : undefined
                    });

                    if (timeoutId) clearTimeout(timeoutId);

                    const responseTime = (performance.now() - startTime).toFixed(2);
                    addResult(`Response received in ${responseTime}ms (HTTP ${response.status})`, 'info');

                    data = await response.json();
                    addResult(`Response data: ${JSON.stringify(data)}`, 'info');

                    if (response.ok && (data.ok || data.success)) {
                        const totalTime = (performance.now() - startTime).toFixed(2);
                        addResult(`✅ SUCCESS! Submission completed in ${totalTime}ms after ${attemptCount} attempt(s)`, 'success');
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'Test Passed!',
                            html: `
                                <p>Submission successful on attempt ${attemptCount}</p>
                                <p class="text-sm mt-2">Total time: ${totalTime}ms</p>
                                <p class="text-sm">HTTP Status: ${response.status}</p>
                            `,
                            confirmButtonColor: '#7c3aed'
                        });
                        return;
                    } else {
                        throw new Error(data.error || `HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (err) {
                    lastError = err;
                    addResult(`❌ Attempt ${attemptCount} failed: ${err.message}`, 'error');
                    retries--;
                    
                    if (retries > 0) {
                        addResult(`Retrying in 1 second... (${retries} attempts remaining)`, 'warning');
                        await new Promise(r => setTimeout(r, 1000));
                    }
                }
            }

            const totalTime = (performance.now() - startTime).toFixed(2);
            addResult(`❌ TEST FAILED after ${attemptCount} attempt(s) in ${totalTime}ms`, 'error');
            addResult(`Final error: ${lastError?.message || 'Unknown error'}`, 'error');

            Swal.fire({
                icon: 'error',
                title: 'Test Failed',
                html: `
                    <p>All ${attemptCount} attempts failed</p>
                    <p class="text-sm mt-2">Total time: ${totalTime}ms</p>
                    <p class="text-sm text-red-600">${lastError?.message || 'Unknown error'}</p>
                `,
                confirmButtonColor: '#dc2626'
            });
        }
    </script>
</body>
</html>
